services:
  # Backend Server
  server:
    build:
      context: ./server
      dockerfile: Dockerfile
      target: ${BUILD_TARGET:-development}
    container_name: resumepro-server
    restart: unless-stopped
    ports:
      - "${SERVER_PORT:-5000}:5000"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=5000
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3000}
      - RAZORPAY_KEY_ID=${RAZORPAY_KEY_ID}
      - RAZORPAY_KEY_SECRET=${RAZORPAY_KEY_SECRET}
      - MONGODB_URI=${MONGODB_URI}
      - MONGODB_DB_NAME=${MONGODB_DB_NAME:-resumepro}
      - EMAIL_HOST=${EMAIL_HOST}
      - EMAIL_PORT=${EMAIL_PORT}
      - EMAIL_USER=${EMAIL_USER}
      - EMAIL_PASSWORD=${EMAIL_PASSWORD}
      - EMAIL_FROM=${EMAIL_FROM}
      - PAYMENT_AMOUNT=${PAYMENT_AMOUNT:-4900}
      - PAYMENT_CURRENCY=${PAYMENT_CURRENCY:-INR}
      - DOWNLOAD_LINK_VALIDITY_DAYS=${DOWNLOAD_LINK_VALIDITY_DAYS:-365}
    volumes:
      # Mount source code for development hot-reload
      - ./server/src:/app/src:ro
      - ./server/package.json:/app/package.json:ro
      # Named volume for node_modules to avoid conflicts with host
      - server_node_modules:/app/node_modules
    networks:
      - resumepro-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - dev
      - prod

  # Frontend Client
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
      target: ${BUILD_TARGET:-development}
    container_name: resumepro-client
    restart: unless-stopped
    ports:
      - "${CLIENT_PORT:-3000}:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:3000}
      - NEXT_PUBLIC_SERVER_URL=${NEXT_PUBLIC_SERVER_URL:-http://localhost:5000}
      - NEXT_PUBLIC_APP_NAME=${NEXT_PUBLIC_APP_NAME:-ResumePro}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
      - NEXT_PUBLIC_RAZORPAY_KEY_ID=${NEXT_PUBLIC_RAZORPAY_KEY_ID}
      - NEXT_PUBLIC_PAYMENT_AMOUNT=${NEXT_PUBLIC_PAYMENT_AMOUNT:-4900}
      - NEXT_PUBLIC_PAYMENT_CURRENCY=${NEXT_PUBLIC_PAYMENT_CURRENCY:-INR}
      - NEXT_PUBLIC_GA_ID=${NEXT_PUBLIC_GA_ID}
      - NEXT_PUBLIC_ENABLE_ANALYTICS=${NEXT_PUBLIC_ENABLE_ANALYTICS:-false}
      - GROQ_API_KEY=${GROQ_API_KEY}
    volumes:
      # Mount source code for development hot-reload
      - ./client/app:/app/app:ro
      - ./client/components:/app/components:ro
      - ./client/lib:/app/lib:ro
      - ./client/templates:/app/templates:ro
      - ./client/public:/app/public:ro
      - ./client/package.json:/app/package.json:ro
      # Named volume for node_modules and .next to avoid conflicts
      - client_node_modules:/app/node_modules
      - client_next:/app/.next
    networks:
      - resumepro-network
    depends_on:
      server:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    profiles:
      - dev
      - prod

  # MongoDB (optional - only for production/testing)
  mongodb:
    image: mongo:7.0
    container_name: resumepro-mongodb
    restart: unless-stopped
    ports:
      - "${MONGO_PORT:-27017}:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USERNAME:-admin}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD:-password}
      - MONGO_INITDB_DATABASE=${MONGODB_DB_NAME:-resumepro}
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - resumepro-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - prod
      - mongodb

networks:
  resumepro-network:
    driver: bridge

volumes:
  server_node_modules:
  client_node_modules:
  client_next:
  mongodb_data:
  mongodb_config:
